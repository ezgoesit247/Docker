#!/bin/bash
### GENERATED BY: dosetup
FROM local/node:ubuntu as vs
VOLUME vs
RUN sudo mkdir /vs && sudo chown -R 1000:1000 /vs && ln -s /vs ~/vs
ARG gituser
RUN git clone git@github.com:$gituser/vs /vs
CMD [ "/bin/bash" ]

FROM vs as docker

### DOCKER ###
RUN sudo apt-get -qq update && sudo apt-get install -qq apt-transport-https ca-certificates gnupg-agent software-properties-common && curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - && sudo apt-key fingerprint 0EBFCD88 && sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" && sudo apt-get -qq update && sudo apt-get install -qq docker-ce docker-ce-cli containerd.io

RUN echo '### DOCKER ###\nif ! sudo service docker status;then sudo service docker start && sleep 1 && sudo service docker status;fi\nif sudo docker run --rm hello-world 2>/dev/null|grep -q "Hello from Docker!"\nthen pass "Docker Hello World"; else fail "Docker Hello World"\nfi\ncyan "Docker:"; docker --version\ncyan "Docker Compose:"; docker-compose --version' >>~/.bashrc


### DOCKER COMPOSE ###
RUN sudo curl -sL https://github.com/docker/compose/releases/download/1.21.2/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose && sudo chmod +x /usr/local/bin/docker-compose


### MONGODB ###
RUN MONGO_RUN=/usr/bin && MONGO_DIR=/usr/local/mongo && MONGO=https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu2004-4.4.6.tgz && sudo mkdir -p ${MONGO_DIR} && curl -s $MONGO | sudo tar zxv --strip-components=1 -C $MONGO_DIR && sudo ln $MONGO_DIR/bin/mongo{,d,s} $MONGO_RUN/ && sudo mkdir -p /var/lib/mongo && sudo mkdir -p /var/log/mongodb && sudo chown $(whoami) /var/lib/mongo && sudo chown $(whoami) /var/log/mongodb \
&& cd /etc/init.d/ && sudo cp ${HOME}/public.assets/mongodb ./mongodb && sudo chmod 755 ./mongodb \
&& cd /etc/rc3.d/ && sudo ln -s ../init.d/mongodb S01mongodb \
&& cd /etc/rc4.d/ && sudo ln -s ../init.d/mongodb S01mongodb \
&& cd /etc/rc5.d/ && sudo ln -s ../init.d/mongodb S01mongodb
sudo service mongodb start
sudo service mongodb status
sudo service mongodb stop
echo 'forked process: 595'|sed 's/[^0-9]*//'


# ON SYSTEMD
RUN wget -qO - https://www.mongodb.org/static/pgp/server-4.4.asc | apt-key add - \
&& echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/4.4 multiverse" | tee /etc/apt/sources.list.d/mongodb-org-4.4.list \
&& apt-get update \
&& apt-get install -y mongodb-org
