#!/bin/bash
### GENERATED BY: dosetup
FROM local/node:ubuntu as dockerizednode
ARG gituser

VOLUME dockerizednode
RUN sudo mkdir /dockerizednode && sudo chown -R 1000:1000 /dockerizednode && ln -s /dockerizednode ~/dockerizednode
RUN git clone git@github.com:$gituser/dockerizednode /dockerizednode

FROM dockerizednode as docker
### DOCKER ###
RUN sudo apt-get -qq update \
&& sudo apt-get install -qq \
apt-transport-https \
ca-certificates \
gnupg-agent \
software-properties-common \
&& curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - \
&& sudo apt-key fingerprint 0EBFCD88 \
&& sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" \
&& sudo apt-get -qq update \
&& sudo apt-get install -qq \
docker-ce \
docker-ce-cli \
containerd.io \
&& sudo usermod -a -G docker $gituser


FROM docker as compose
### DOCKER COMPOSE ###
RUN sudo curl -sL https://github.com/docker/compose/releases/download/1.21.2/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose\
&& sudo chmod +x /usr/local/bin/docker-compose

FROM compose as end
RUN echo '### DOCKER ###\n\
if ! sudo service docker status;then sudo service docker start && sleep 1 && sudo service docker status;fi\n\
if sudo run --rm hello-world 2>/dev/null|grep -q "Hello from Docker!"\n\
then pass "Docker Hello World"; else fail "Docker Hello World"\n\
fi\n\
cyan "Docker:"; docker --version\n\
cyan "Docker Compose:"; docker-compose --version'\
>>~/.bashrc
RUN sudo apt-get clean
CMD [ "/bin/bash" ]
EXPOSE 8080
