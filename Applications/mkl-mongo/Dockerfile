#!/bin/bash
### GENERATED BY: dosetup
FROM local/seedling:ubuntu as mkl-mongo
RUN apt-get install -qq sudo curl && echo "ALL ALL=(ALL) NOPASSWD: ALL" >>/etc/sudoers
ARG gituser
RUN groupadd -g 1000 $gituser && useradd -ms /bin/bash -u 1000 -g 1000 $gituser
USER $gituser
WORKDIR ~
RUN echo 'export PS1="\\[\\033[1;34m\\]\\u\\[\\033[0m\\]@\\[\\033[1;31m\\]\\h:\\[\\033[0;37m\\]\\w\\[\\033[0m\\] \$ "\nalias ls="ls -Altr --color=auto"\n'>>~/.bashrc
CMD [ "/bin/bash" ]
FROM mkl-mongo as mkl-mongopackages

### MONGODB ###
ARG MONGO_RUN=/usr/bin
ARG MONGO_DIR=/usr/local/mongo
ARG MONGO=https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu2004-4.4.6.tgz
COPY assets.mongo/mongodb.service /etc/init.d/mongodb.service
RUN sudo mkdir -p $MONGO_DIR && curl -s $MONGO | sudo tar zxv --strip-components=1 -C $MONGO_DIR
RUN sudo ln $MONGO_DIR/bin/mongo $MONGO_RUN/ && sudo ln $MONGO_DIR/bin/mongos $MONGO_RUN/ && sudo ln $MONGO_DIR/bin/mongod $MONGO_RUN/
RUN sudo chmod 755 /etc/init.d/mongodb.service && cd /etc/rc3.d/ && sudo ln -s ../init.d/mongodb.service S01mongodb && cd /etc/rc4.d/ && sudo ln -s ../init.d/mongodb.service S01mongodb && cd /etc/rc5.d/ && sudo ln -s ../init.d/mongodb.service S01mongodb
#sudo service mongodb start
#sudo service mongodb status
#sudo service mongodb stop
#echo 'forked process: 595'|sed 's/[^0-9]*//'

ARG mongo_user="\
use admin\
db.createUser( {\
user: \"MONGOUSERENAME\",\
pwd: \"MONGOUSERPASSWORD\",\
roles: [ { role: \"userAdminAnyDatabase\", db: \"admin\" } ]\
} )"
RUN mkdir -p ~/mongo_setup && echo $mongo_user >~/mongo_setup/mongo_user.in.mongo
#&& npm install mongoose

