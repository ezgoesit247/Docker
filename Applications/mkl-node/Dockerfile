#!/bin/bash
### GENERATED BY: dosetup
FROM local/node:ubuntu as vs-node
VOLUME vs-node
RUN sudo mkdir /vs-node && sudo chown -R 1000:1000 /vs-node && ln -s /vs-node ~/vs-node
ARG gituser
RUN git clone git@github.com:$gituser/vs-node /vs-node
CMD [ "/bin/bash" ]

FROM vs-node as docker

### DOCKER ###
RUN sudo apt-get -qq update && sudo apt-get install -qq apt-transport-https ca-certificates gnupg-agent software-properties-common && curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - && sudo apt-key fingerprint 0EBFCD88 && sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" && sudo apt-get -qq update && sudo apt-get install -qq docker-ce docker-ce-cli containerd.io && sudo usermod -a -G docker $gituser

RUN echo '### DOCKER ###\nif ! sudo service docker status;then sudo service docker start && sleep 1 && sudo service docker status;fi\nif docker run --rm hello-world 2>/dev/null|grep -q "Hello from Docker!"\nthen pass "Docker Hello World"; else fail "Docker Hello World"\nfi\ncyan "Docker:"; docker --version\ncyan "Docker Compose:"; docker-compose --version' >>~/.bashrc

ARG dockerpushnodeapp="function dockerpushnodeapp { echo \$(cat \${DOCKERHUBTOKEN})|docker login -u \$(cat \${DOCKERHUBUSER}) --password-stdin && docker push \$(cat \${DOCKERHUBUSER})/\$(PACKAGE); }"
RUN echo '\n'$dockerpushnodeapp'\n'>>~/.bashrc


### DOCKER COMPOSE ###
RUN sudo curl -sL https://github.com/docker/compose/releases/download/1.21.2/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose && sudo chmod +x /usr/local/bin/docker-compose

