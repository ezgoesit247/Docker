#!/bin/bash

NAME="--rm"
for i in "$@"
do
case $i in
        -n=*|--name=*)
        NAME="--name ${i#*=}"
        IMAGE=${1}
        shift # past argument=value
        ;;
        *)
        IMAGE=${1}
        ;;
esac
done

if [ -z $1 ]; then echo "Looking for container image: ${PWD##*/}"
if ! docker run --privileged -it -P \
  -v ${PWD}:/home/poweruser/_assets.local \
  -v ${HOME}/Docker/_shared_assets:/home/poweruser/_assets \
  -v ${HOME}/.m2:/home/poweruser/.m2 \
  -v ${HOME}/.aws:/home/poweruser/.aws \
  -v ${HOME}/.ssh:/home/poweruser/.ssh \
  --user poweruser \
  --rm \
  ${PWD##*/} 2> /dev/null; then echo "Usage: run NOARGS must be in parent dir\n     run [NAME] saves container if in parent dir, else creates anonymous"; fi
else
if ! docker run --privileged -it -P \
  -v ${PWD}:/home/poweruser/_assets.local \
  -v ${HOME}/Docker/_shared_assets:/home/poweruser/_assets \
  -v ${HOME}/.m2:/home/poweruser/.m2 \
  -v ${HOME}/.aws:/home/poweruser/.aws \
  -v ${HOME}/.ssh:/home/poweruser/.ssh \
  --user poweruser \
  --name ${1} \
  ${PWD##*/} 2> /dev/null
   then echo "looking for container ${1}..." && if docker start ${1} > /dev/null 2>&1; then docker attach ${_}
   else echo "can't start, running container: docker run --privileged -it -P ${1}" && docker run --privileged -it -P \
     -v ${PWD}:/home/poweruser/_assets.local \
     -v ${HOME}/Docker/_shared_assets:/home/poweruser/_assets \
     -v ${HOME}/.m2:/home/poweruser/.m2 \
     -v ${HOME}/.aws:/home/poweruser/.aws \
     -v ${HOME}/.ssh:/home/poweruser/.ssh \
     --user poweruser \
     ${NAME} \
     ${IMAGE}
fi
fi
fi
